services:
  server:
    container_name: rovierr-server
    build:
      context: .
      dockerfile: apps/server/Dockerfile
    ports:
      - '3000:3000'
    env_file:
      - ./apps/server/.env
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOST=0.0.0.0
    depends_on:
      - realtime
    restart: unless-stopped

  realtime:
    container_name: rovierr-realtime
    build:
      context: ./packages/realtime
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    env_file:
      - ./packages/realtime/.env
    restart: unless-stopped

  id-parser:
    container_name: rovierr-id-parser
    build:
      context: ./packages/id-parser
      dockerfile: Dockerfile.dev
    ports:
      - "8001:8000"
    volumes:
      # Mount source code for hot reloading
      - ./packages/id-parser:/app
      # Use anonymous volumes to exclude cache directories (prevents host conflicts)
      - /app/__pycache__
      - /app/.venv
    restart: unless-stopped
    develop:
      watch:
        # Rebuild container when Dockerfile or dependencies change
        # Note: File changes are handled by volume mount + uvicorn --reload
        - action: rebuild
          path: ./packages/id-parser/Dockerfile.dev
        - action: rebuild
          path: ./packages/id-parser/pyproject.toml
        - action: rebuild
          path: ./packages/id-parser/uv.lock
